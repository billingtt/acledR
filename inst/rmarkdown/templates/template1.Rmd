---
title: "Automatic Report of Country through API call"
output:
    html_document:
      toc: true
      fig_crop: no
      toc_float: true
    pdf_document:
      toc: true
      fig_crop: no
params:
  acled_email: email  
  acled_key: key   
  end_date: !r Sys.Date()
  country: country          
  printcode: TRUE 
  start_date: "1997-01-01"
  data: data
subtitle: "Country: `r params$country` - From: `r params$start_date` to `r params$end_date`"  

---

<style type="text/css">
.main-container {
  max-width: 1400px;
  margin-left: auto;
  margin-right: auto;
}
</style>


```{r loading what we need, echo=FALSE}
library(acledR)
library(knitr)
library(kableExtra)
library(dplyr)
library(tidyr)
library(plotly)
library(viridis)
library(mapview)
library(stringr)
library(sf)


defaultW <- getOption("warn") 

options(warn = -1)


```

## 1. General statistics

```{r table of statistics, echo=FALSE}


table_data_source <- acled_transform(params$data, type = "source") %>%
  group_by(source) %>%
  summarise(frequency = n()) %>%
  arrange(-frequency)

unique_number_of_sources <- length(unique(table_data_source$source))

table_data_actor <- acled_transform(params$data, type = "full_actors")%>%
  group_by(actor) %>%
  summarise(frequency = n()) %>%
  arrange(-frequency)

unique_number_of_actors <- length(unique(table_data_actor$actor))


table_data <- params$data %>%
  mutate(event_date = as.character(event_date))%>%
  group_by(country) %>%
  summarise(total_events = n(),
            total_fatalities = sum(fatalities),
            eventful_days = n_distinct(event_date))
table_data$total_actors <- unique_number_of_actors
table_data$total_sources <- unique_number_of_sources

kbl(table_data) %>%
  kable_styling()



```

### 1.1 Most Frequent Sources

```{r sources brealdown, echo = FALSE, fig.align='right',fig.width=10,fig.height=7}
su <- ggplot(slice_max(.data = table_data_source,order_by = frequency, n=30),aes(frequency,reorder(source,frequency),fill=source,text=c(paste0("Source: ", source,"\n","Frequency: ", frequency)))) +
  geom_bar(stat="identity",fill= "slateblue3")+
  theme(legend.position = "none")+
  labs(title = "Top 30 most frequent sources utilized in the dataset",
       x= "Frequency",
       y= "Source")
ggplotly(su,tooltip = "text")
```

### 1.2 Most Frequent Actors

```{r actor breakdown, echo = FALSE, fig.align='right',fig.width=10,fig.height=7}
fu <- ggplot(slice_max(table_data_actor,order_by = frequency,n=30),
             aes(frequency,reorder(actor,frequency),text=c(paste0("Actor: ", actor,"\n","Frequency: ", frequency))))+
  geom_bar(stat="identity", fill= "slateblue3")+
  theme(legend.position="none")+
  labs(title = "Top 30 most frequent actors in the dataset",
       x="Frequency",
       y="Actor")

ggplotly(fu, tooltip = "text")
```

### 1.3 Sub Event Types frequencies

```{r sub event type,echo = FALSE, fig.align='right',fig.width=10,fig.height=7}
sub_event_table <- params$data %>%
  group_by(event_type,sub_event_type) %>%
  summarise(frequency = n())

zu <-ggplot(sub_event_table,aes(x=frequency,fill=event_type,
                                text= c(
                                  paste0("Sub event type: ", sub_event_type,"\n",
                                         "Event Type: ",event_type, "\n",
                                         "Frequency: ", frequency))))+
      geom_bar(aes(y=reorder(sub_event_type,frequency)),stat="identity", size=10)+
      scale_x_continuous(trans="log10")+
      labs(title = "Magnitude of sub event types in a log10 scale",
           x="Frequency in a 10 logarithmic scale",
           y="Sub Event Types",
           fill = "Event Types")

ggplotly(zu, tooltip = "text")

```

## 2. Monthly average of events in `r params$country`

```{r moving avergeas, echo = FALSE, fig.align='right',fig.width=10,fig.height=7}

df1 <- params$data %>%
  generate_counts(.,
                  unit_id = "country",
                  time_id = "event_date",
                  time_target = "month")

# Generate 3 moving average of total events per month
df1m <-
  generate_movers(data = df1,
                  var = "total_events",
                  unit_id = "country",
                  time_id = "event_month",
                  slide_funs = "mean",
                  slide_periods = 3)

average_per_year <- df1 %>%
  mutate(year = lubridate::floor_date(event_month,unit = "year")) %>%
  group_by(year) %>%
  summarise(average_events_per_month = mean(total_events))

ha <- ggplot(df1m, aes(x=event_month, text = paste0("Month & Year: ",lubridate::format_ISO8601(event_month,precision = "ym"),"\n","3 months moving average: ", total_events_moving_mean_3, "\n", "Total number of events this month: ", total_events)))+
    geom_point(aes(y=total_events))+
    geom_line(aes(y=total_events_moving_mean_3, group=1, color = "3 Months Moving Average"))+
    # geom_line(data=average_per_year,aes(x=year,y=average_events_per_month), color = "green")+
    labs(title = paste0("Moving 3 months average of total events in ", params$country),
         x= "Month - Year",
         y= "Number of Events")+
     scale_colour_manual(name = 'Legend',
         values=c('3 Months Moving Average' = 'blue'))

ggplotly(ha, tooltip = "text")

```



## 3. Map of events distribution in the country per admin1 levels

```{r map of stuff,echo = FALSE, fig.align='right',fig.width=10,fig.height=7}


admin1_country <- raster::getData(name = "GADM", country = params$country, level = 1) %>%
  # convert to sf object
  st_as_sf()

country_counts <-
  params$data %>% 
  # full_join(select(admin1_country, NAME_1, NAME_0), by = c("admin1" = "NAME_1", "country" = "NAME_0")) %>% 
  group_by(admin1) %>% 
  tally() %>% 
  full_join(admin1_country, by = c("admin1" = "NAME_1")) %>% 
  mutate(n = case_when(
    is.na(n) ~ 0L,
    TRUE ~ n
  )) %>%
  sf::st_as_sf()

library(mapview)
mapviewOptions(fgb = FALSE) # needed when creating web pages
mapview(country_counts["n"], at = seq(1,2500,200))

```

## 4. Events & Fatalities of Organized political violence (OPV) and Violence targeting civilians (VTC)


```{r get counts of events by event_types, echo = F, warning = FALSE, message = FALSE}

organized_political_violence_set <- c("Sexual Violence","Attack","Abduction/forced disappearance","Armed clash","Non-state actor overtakes territory", "Government regains territory","Chemical weapon","Air/drone strike","Suicide bomb","Shelling/artilery/missile attack","Remote explosive/landmine/IED")

violence_targeting_civilians_set <- c("Sexual violence","Attack","Abduction/forced disappearance") # Plus the if statement


totals_event_counts <- params$data%>%
  filter(event_date >= params$start_date & event_date <= params$end_date)%>%
  mutate(opc_vtc_category = case_when(
    sub_event_type %in% organized_political_violence_set ~ "organized_political_violence",
    sub_event_type %in% violence_targeting_civilians_set ~ "violence_targeting_civilians",
    event_type == "Explosive/remote violence" & (inter1 == 6 | inter2 == 6 | inter1==7 | inter2 ==7) ~ "violence_targeting_civilians",
    TRUE ~ "NA"
  )) %>%
  filter(opc_vtc_category != "NA")%>%
  group_by(opc_vtc_category) %>%
  summarise(n_events = n(),
            n_fatalities = sum(fatalities))%>%
  mutate(sub_event_type = case_when(
    opc_vtc_category == "organized_political_violence" ~ "Total OPV",
    opc_vtc_category == "violence_targeting_civilians" ~ "Total VTC"
  ))
  

df1 <- params$data %>%   ## change to params$data
  filter(event_date >= params$start_date & event_date <= params$end_date)%>%
  mutate(opc_vtc_category = case_when(
    sub_event_type %in% organized_political_violence_set ~ "organized_political_violence",
    sub_event_type %in% violence_targeting_civilians_set ~ "violence_targeting_civilians",
    event_type == "Explosive/remote violence" & (inter1 == 6 | inter2 == 6 | inter1==7 | inter2 ==7) ~ "violence_targeting_civilians",
    TRUE ~ "NA"
  )) %>%
  filter(opc_vtc_category != "NA")%>%
  group_by(opc_vtc_category,sub_event_type) %>%
  summarise(n_events = n(),
            n_fatalities = sum(fatalities))%>%
  rbind(totals_event_counts)%>%
  arrange(opc_vtc_category)


min_opv <- min(which(grepl("organized_political_violence", df1$opc_vtc_category)))
max_opv <- max(which(grepl("organized_political_violence", df1$opc_vtc_category)))

min_vtc <- min(which(grepl("violence_targeting_civilians", df1$opc_vtc_category)))
max_vtc <- max(which(grepl("violence_targeting_civilians", df1$opc_vtc_category)))

if(min_vtc == Inf | max_vtc == Inf){
  include_vtc <- 0
} else {include_vtc <- 1}

if(min_opv == Inf | max_opv == Inf){
  include_opv <- 0
} else {include_opv <- 1}


stuff <- params$data

df1 %>%
  mutate(opc_vtc_category = "")%>%
  rename(" "= opc_vtc_category)%>%
  kbl(caption = paste0("Table of event counts and fatalities by sub event type since ", min(stuff$event_date), " until ", max(stuff$event_date)),align = "c",col.names = c("","Sub Event Types", "Number of Events", "Number of Fatalities"))%>%
  kable_styling(full_width =T)%>%
  {if(include_vtc == 1 & include_opv == 1) pack_rows("Violence Targeting Civilians",min_vtc,max_vtc) %>% pack_rows("Organized Political Violence",min_opv,max_opv) else . } %>%
  {if(include_vtc != 1) footnote(.,general = "There were no Violence Targenting Civilians events in the Dataset") else if (include_opv != 1) footnote(.,general = "There were no Organized Political Violence events in the dataset") else .}



```

## 5. Monthly counts of events & Fatalities of Organized political violence and Violence targeting civilians, since `r params$start_date` {.tabset .tabset-pills}
### 5.1 Comparison of fatalities and number of events
```{r plotting counts per month, echo = FALSE, fig.align='right',fig.width=10,fig.height=7}

df1_month <- params$data %>%
  filter(event_date >= params$start_date & event_date <= params$end_date)%>%
  mutate(opc_vtc_category = case_when(
    sub_event_type %in% organized_political_violence_set ~ "Organized Political Violence",
    sub_event_type %in% violence_targeting_civilians_set ~ "Violence Targeting Civilians",
    event_type == "Explosive/remote violence" & (inter1 == 6 | inter2 == 6 | inter1==7 | inter2 ==7) ~ "Violence Targeting Civilians",
    TRUE ~ "NA"
  )) %>%
  filter(opc_vtc_category != "NA")%>%
  group_by(month = lubridate::floor_date(event_date,unit="month"),opc_vtc_category) %>%
  summarise(total_events = n(),
            total_fatalities = sum(fatalities))  %>%
  pivot_longer(names_to = "variable", cols = starts_with("total_"), names_repair = "minimal") 


p <- ggplot(df1_month,aes(x=month,y=value))+
  geom_line(aes(col = variable))+
  scale_color_manual(values = c("navyblue","tomato3"))+
  facet_wrap(opc_vtc_category ~ ., scale = "free", nrow=2)+
  theme(strip.background = element_rect(fill="midnightblue"),
          strip.text = element_text(face="bold",colour = "white"))


ggplotly(p)

```


### 5.2 Organized political violence Sub-events breakdown of number of events per month

```{r breakdown of sub event type plot opv, echo = FALSE, fig.align='right',fig.width=8,fig.height=6}

breakdown_opv_facet <- params$data %>%
  filter(event_date >= params$start_date & event_date <= params$end_date)%>%
  mutate(opc_vtc_category = case_when(
    sub_event_type %in% organized_political_violence_set ~ "organized_political_violence",
    sub_event_type %in% violence_targeting_civilians_set ~ "violence_targeting_civilians",
    event_type == "Explosive/remote violence" & (inter1 == 6 | inter2 == 6 | inter1==7 | inter2 ==7) ~ "violence_targeting_civilians",
    TRUE ~ "NA"
  )) %>%
  filter(opc_vtc_category == "organized_political_violence")%>%
  group_by(Month = lubridate::floor_date(event_date,unit="month"),sub_event_type) %>%
  summarise(n_events = n(),
            n_fatalities = sum(fatalities)) %>%
  ggplot(aes(x=Month,y=n_events))+
    geom_line()+
    facet_wrap(sub_event_type ~ .)+
    theme(strip.background = element_rect(fill="midnightblue"),
          strip.text = element_text(face="bold",colour = "white"))+
    labs(title = "Breakdown of \"Organized Political Violence\" sub event types event counts per month")

ggplotly(breakdown_opv_facet)

```



```{r scattered chart of OPV sub events by month, echo = FALSE, fig.align='right',fig.width=10,fig.height=6}

stacked_opv <- params$data%>%
  filter(event_date >= params$start_date & event_date <= params$end_date)%>%
  mutate(opc_vtc_category = case_when(
    sub_event_type %in% organized_political_violence_set ~ "organized_political_violence",
    sub_event_type %in% violence_targeting_civilians_set ~ "violence_targeting_civilians",
    event_type == "Explosive/remote violence" & (inter1 == 6 | inter2 == 6 | inter1==7 | inter2 ==7) ~ "violence_targeting_civilians",
    TRUE ~ "NA"
  )) %>%
  filter(opc_vtc_category == "organized_political_violence")%>%
  group_by(Month = lubridate::floor_date(event_date,unit="month"),sub_event_type) %>%
  summarise(n_events = n(),
            n_fatalities = sum(fatalities)) %>%
  ggplot(aes(x=Month,y=n_events, shape = sub_event_type, color = sub_event_type))+
    geom_point()+
    labs(title = "Graph of \"Organized Political Violence\" sub event types monthly counts")

ggplotly(stacked_opv)

```

### 5.3 Violence Targeting Civilians Sub-events breakdown of number of events per month

```{r scattered chart of VTC sub events by month, echo = FALSE, fig.align='right',fig.width=10,fig.height=6}

stacked_vtc <- params$data%>%
  filter(event_date >= params$start_date & event_date <= params$end_date)%>%
  mutate(opc_vtc_category = case_when(
    sub_event_type %in% organized_political_violence_set ~ "organized_political_violence",
    sub_event_type %in% violence_targeting_civilians_set ~ "violence_targeting_civilians",
    event_type == "Explosive/remote violence" & (inter1 == 6 | inter2 == 6 | inter1==7 | inter2 ==7) ~ "violence_targeting_civilians",
    TRUE ~ "NA"
  )) %>%
  filter(opc_vtc_category == "violence_targeting_civilians")%>%
  group_by(Month = lubridate::floor_date(event_date,unit="month"),sub_event_type) %>%
  summarise(n_events = n(),
            n_fatalities = sum(fatalities)) %>%
  ggplot(aes(x=Month,y=n_events, shape = sub_event_type, color = sub_event_type))+
    geom_point()+
    labs(title = "Scattered chart of \"Violence Targeting Civilians\" sub event types monthly counts")

ggplotly(stacked_vtc)

```


```{r resetting options, echo=FALSE}
options(warn = defaultW)
```


