---
title: "Keeping your dataset up to date"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Deletions API: Keeping your dataset up to date}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)

defaultW <- getOption("warn") 

options(warn = -1) 

```

ACLED is a living dataset, which means changes happen regularly.

Three types of changes are recurrent in ACLED's dataset:

-   New events
    -   These are the weekly addition of events, all are published with a new distinctive *event_id_cnty*.
-   Updates of previously published events
    -   In some cases, we modify published events, as new information may appear. For example, a particular actor has claimed responsibility for an attack, or the number of fatalities has changed. In these cases, the *event_id_cnty* remains the same, but the new information is updated, and the old information overwritten - including the *timestamp*.
-   Deletion of events
    -   In some cases, we have to delete previous events. This happens when new information surfaces indicating that the event no longer fits the scope of ACLED's dataset, or it hints that two events are the same and the events are then merged. In these cases, the event is removed, including the *event_id_cnty*.

For users with a personal ACLED file, it is advised to check regularly which events are no longer in the actual ACLED dataset, and which have been updated.
Otherwise, users risk having an outdated version.
In this section, we will walk through how to keep your dataset updated with the `acledR` package.

## Keeping check of updates - `acled_update()`

As we covered in the more detailed guide about [updating your dataset](https://acleddata.com/download/35179/), in some cases, events are updated.
When they are updated, their *event_id_cnty* remains the same but all the rest of the information gets updated and overwritten.

Different from [deleted events](https://acled.github.io/ACLED-api-guide/deleted_endpoint.html), there is no separate API endpoint to check for updated events.
When events are updated, their timestamp changes to the timestamp of the update.
This means, that you can find the modified events by utilizing `acledR::acled_api()` and providing your latest timestamp (i.e. `max({your ACLED dataset}$timestamp))`) in the `timestamp` argument of the function.
If you get duplicated events, these are likely to be updated events, so you should keep only the ones with a higher timestamp.

When events are deleted, however, their *event_id_cnty* also gets deleted.
For that, users can employ `acled_deletion_api()` to gather the *event_id_cnty* of deleted events, which you can use to filter out these events from your dataset.
While users can find an example below, we kindly suggest you visit our [guide](https://acleddata.com/download/35179/) and more specific guidance about the `deletions` [endpoint](https://acled.github.io/ACLED-api-guide/deleted_endpoint.html) in our API interactive guide.

To simplify both of these processes, `acledR` includes a function that updates your dataset, by checking for new and modified events, as well as removing deleted events: `acled_update()`.

```{r, eval=F}
acled_update(
  df,
  countries = NULL,
  regions = NULL,
  event_types = NULL,
  acled_access = TRUE,
  email = NULL,
  key = NULL,
  deleted = TRUE,
  prompts = T)
```

The function is composed of the following arguments:

-   `df`: The data frame to update.
    It has to have the same structure as ACLED's dyadic data frames (i.e. the result of `acled_api()`)

-   `start_date`: Along with `end_date` these determine the temporal range for your update.
    They default to the date range of `df`.

-   `end_date`: Along with `start_date` these determine the temporal range for your update.
    They default to the date range of `df`.

-   `countries`: In case your dataset includes particular countries, you can add them here so that the function filters new events to those countries.

-   `regions`: In case your dataset includes particular regions, you can add them here so that the function filters new events to those regions.

-   `event_types`: In case of your dataset includes particular event_types, you can add them here so that the function filters new events to those event_types.

-   `acled_acess`: If you have already utilized `acled_acess()`, you can set this option as TRUE (default), and you won't be required to input email or key.

-   `email`: The email registered in [ACLED's Access Portal](https://developer.acleddata.com/).
    Not required if `acled_access = TRUE`.

-   `key`: The key registered in [ACLED's Access Portal](https://developer.acleddata.com/).
    Not required if `acled_access = TRUE`.

-   `deleted`: If TRUE, this function will also deal with deleted events, utilizing [ACLED API's deleted endpoint](https://acled.github.io/acledR/articles/acled_deletions_api.html).

-   `prompts`: Use this option to suppress or allow prompts regarding your call.
    See `acled_api()`.

`acled_update()` will utilize the dataset you provide to gather new events based on the timestamp and add them to the original dataset, as well as remove any deleted events (if `deleted = TRUE`).

## Examples

In this section, we will show how to use `acled_update` to keep your datasets updated.

Load the dataset:

```{r, eval = T, message=FALSE}
library(acledR)
library(lubridate)
library(dplyr)
```

```{r}
acled_access(email = "acledexamples@gmail.com", key = "M3PWwg3DIdhHMuDiilp5") #  This is an example, you will need to input your credentials.

dummy_acled_file <- acledR::acled_old_deletion_dummy # Here is our old personal ACLED dataset
```

When was the last time you gathered your dataset? - The snippet below checks that.

```{r}
latest_timestamp_unix <- max(dummy_acled_file$timestamp)

latest_timestamp <- as_datetime(latest_timestamp_unix) 
```

The dataset has not been updated since `r date(latest_timestamp)` , so you may need to update it.
To do so, you just have to utilize `acled_update()`.
In order to keep the update within the dates of our dataset, you can ignore the `start_date` and `end_date` arguments.
Similarly, we keep `deleted=TRUE` to also remove deleted events.

```{r}

# Get the countries in the dataset to avoid asking for events of countries that are not relevant for your dataset. 
countries_in_dataset <- levels(mutate(dummy_acled_file, country = factor(country))$country)
event_types_in_dataset <- levels(mutate(dummy_acled_file, country = factor(event_type))$event_type)


new_dataset <- acled_update(dummy_acled_file, 
                                  countries = countries_in_dataset,
                                  event_types = event_types_in_dataset,
                                  acled_access = T, 
                                  prompts = FALSE) 
```

Now your dataset captures deleted, modified, and newly created events.

Best of luck!

```{r, echo=F}
options(warn = defaultW)
```
