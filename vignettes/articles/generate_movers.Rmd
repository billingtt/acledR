---
title: "Generate Moving Statistics"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Generate Moving Statistics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning=F, message=F,
  cache = F
)
```

The `generate_movers()` function generates __moving statistics__ of ACLED event counts. The moving statistics summarize the variation in event counts over a designated period of time. A common example would be a __moving average__, which would represent the average number of events over a specified period of time until the present observation. 

The required parameters are as follows:

```{r, eval = F}
generate_movers(
  data,
  var,
  unit_id,
  time_id,
  slide_funs,
  slide_periods
)
```

where `data` is event count data from ACLED, `unit_id` is the spatial unit of analysis (e.g., country, ADMIN1, region), `time_id` is the temporal unit (e.g., week, month, year), `slide_funs` are the requested moving statistics (e.g., mean, sd, median, min, max), and `slide_periods` are the number of temporal units over which to calculate the moving statistics. The `unit_id` and `time_id` must be existing columns in your event count dataframe.

As an initial example, let's first pull ACLED data for India since 2018 using the `acled_api()` function:

```{r}
library(acledR)
acled_access(email = "acledexamples@gmail.com", key = "M3PWwg3DIdhHMuDiilp5") #  This is an example, you will need to input your credentials.
df_india <- acled_api(countries = "India",
                   start_date = "2018-01-01",
                   end_date = "2022-04-30",
                   monadic = F)
```

Next, we can aggregate to event counts per month using the `generate_counts()` function:
```{r}
df_india_agg <-
  df_india %>% 
  generate_counts(., 
                  unit_id = "country", 
                  time_id = "event_date",
                  time_target = "month")
```

We now have a tibble of ACLED event counts by month for each event type, as well the sum across event types:

```{r}
df_india_agg %>% dplyr::glimpse()
```

With these event counts, we can use `generate_movers()` to calculate moving statistics from these variables. Let's create a new variable for the moving average of `total_events` over the last 3 months:

```{r}
df_india_agg_movers <- 
  generate_movers(data = df_india_agg,
                  var = "total_events",
                  unit_id = "country",
                  time_id = "event_month",
                  slide_funs = "mean",
                  slide_periods = 3)
```

We now have a new column for the requested moving average: `total_events_moving_mean_3`. We can take a look at the first few rows of our variables of interest:

```{r}
df_india_agg_movers %>% 
  dplyr::select(country, 
                event_month, 
                total_events, 
                total_events_moving_mean_3)
```

Note that the first 3 months for `total_events_moving_mean_3` are missing. This is because there has not been enough elapsed time in the sample to calculate a complete moving statistic of the requested temporal length. This default behavior can be turned off by setting `complete = F` in the `generate_movers()` call. 

To see how this would change the returned values, consider the following:

```{r}
generate_movers(data = df_india_agg,
                  var = "total_events",
                  unit_id = "country",
                  time_id = "event_month",
                  slide_funs = "mean",
                  slide_periods = 3,
                  complete = F) %>% 
  dplyr::select(country, event_month, total_events, 
         total_events_moving_mean_3)
```

Here, the first period returns NaN values, while the second period simply fills the first observed value. By the fourth period, the moving averages for the default `complete = T` and `complete = F` versions are the same, as both are calculated moving statistics over a 3 month period. 

Sticking with the default `complete = T` version, we can quickly visualize the trend in event counts over time with `ggplot2`:

```{r, fig.width=7, fig.height=4.5}
library(ggplot2)

df_india_agg_movers %>% 
  
  ggplot() +
  geom_line(aes(x = event_month, y = total_events,
                linetype = "Total events")) +
  geom_line(aes(x = event_month, y = total_events_moving_mean_3,
                linetype = "Moving average (3 months)")) +
  scale_linetype_manual(values = c(3, 1),
                        guide = guide_legend(title = NULL)) +
  theme_light() +
  theme(legend.position = c(0.8, 0.885),
        legend.background = element_rect(color = "gray90"),
        panel.grid = element_blank())

```
