---
title: "Generate Event Counts"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Generate Event Counts}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning=F, message=F,
  cache = F
)
```

# Generating counts of ACLED events

The `generate_counts()` function creates event counts by event type and spacial and temporal units of analysis. 

The required arguments are:

```{r, eval = F}
generate_counts(
  data,
  unit_id,
  time_id,
  time_target
)
```

where `data` is ACLED event-level data, `unit_id` is the spatial unit of analysis (e.g., country, ADMIN1, region), `time_id` is the temporal unit (i.e., `event_date` normally), and `time_target` is the temporal unit of aggregation (e.g., week, month, year). If `time_target = week`, the ACLED week (starting on Saturday) is used - see (time)[__here would go the time vignette link__]

As an example, we can take the data for South America.

```{r}
library(acledR)
acled_access(email = "acledexamples@gmail.com", key = "M3PWwg3DIdhHMuDiilp5") #  This is an example, you will need to input your credentials.
df_sa <- acled_api(regions = c("South America"),
                   start_date = "2022-01-01",
                   end_date = "2022-04-30",
                   monadic = F)
```

We can then generate event counts at the country-week level:

```{r}
df_sa_agg_weekly <-
  df_sa %>% 
  generate_counts(., 
                  unit_id = "country", 
                  time_id = "event_date",
                  time_target = "week")
```

This returns a tibble with columns for each event type in the data, as well as a column for the total events:

```{r}
df_sa_agg_weekly %>% 
  head() %>% 
  kableExtra::kable()
```

We can also limit the request to certain event types. For example, we might only want political violence events:

```{r}
df_sa_agg_weekly_pv <-
  df_sa %>% 
  generate_counts(., unit_id = "country", 
                  time_id = "event_date",
                  time_target = "week",
                  event_type = c("Battles", 
                                 "Violence against civilians", 
                                 "Explosions/Remote violence", 
                                 "Riots"))  ## This needs to be changed, it is only mob violence
```

Now we only retain the requested event types and the total corresponds to these types only:

```{r}
df_sa_agg_weekly %>% 
  head() %>% 
  kableExtra::kable()
```

If instead we wanted violent event counts by month rather than week, we would simply swap `time_target = week` to `time_target = month`:

```{r}
df_sa_agg_monthly_pv <-
  df_sa %>% 
  generate_counts(., unit_id = "country", 
                  time_id = "event_date",
                  time_target = "month",
                  event_type = c("Battles", 
                                 "Violence against civilians", 
                                 "Explosions/Remote violence", 
                                 "Riots"))
```

# Examples

## How have event types in Africa changed over time?

An analyst may be interested in how conflict event types have changed over time within a continent. In this example, consider Africa since 2018. Since ACLED can code multiple regions within each continent, we need to identify all regions that fall within Africa. We can see all ACLED regions by calling the `acledR::acled_regions` data.

Here, we see 5 regions in Africa, as well as the first date for which events were coded in each region. 

```{r}
acledR::acled_regions
```

We can store these region names in a vector called `africa_regions` and request data for each country within these regions since 2018.

```{r}
africa_regions <- c("Western Africa", 
                    "Middle Africa", 
                    "Eastern Africa", 
                    "Southern Africa",
                    "Northern Africa")

df_africa <- acled_api(regions = africa_regions,
                       start_date = "2018-01-01",
                       end_date = "2022-04-30",
                       monadic = F)
```

We can then generate event counts for each month by each region in Africa:

```{r}
df_africa_monthly <-
  df_africa %>% 
  generate_counts(., unit_id = "region", 
                  time_id = "event_date",
                  time_target = "month",
                  event_type = c("Battles", 
                                 "Violence against civilians", 
                                 "Explosions/Remote violence", 
                                 "Riots"))
```

We can create a stacked bar plot of event types over time by country with `ggplot2` by pivoting the data such that each region-event type combination is one row and filtering out the `total_events` event type:

```{r, fig.width=6, fig.height=8}
library(ggplot2)

df_africa_monthly %>% 
  tidyr::pivot_longer(cols = -c(region, event_month)) %>% 
  dplyr::filter(name != "total_events") %>% 
  
  ggplot() +
  geom_bar(aes(x = event_month, 
               fill = name,
               y = value,
               group = region),
           position = "stack", stat = "identity") +
  facet_wrap(~region, nrow = 3) +
  scale_fill_viridis_d(option = "inferno", 
                       begin = 0.1,
                       end = 0.9,
                       guide = guide_legend(title = "Event Type",
                                            reverse = T)) +
  theme_light() +
  theme(legend.position = c(0.75, 0.15),
        legend.background = element_rect(color = "gray90"))



```
