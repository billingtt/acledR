---
title: "Generate Event Counts"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{generate_counts}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning=F, message=F,
  cache = T
)
```



The `generate_counts()` function quickly creates event counts by event type and unit of analysis. 

In the most basic usage, the required arguments are:

```{r, eval = F}
generate_counts(
  data,
  unit_id,
  time_id,
  time_target
  )
```
where `data` is ACLED event-level data, `unit_id` is the spatial unit of analysis (e.g., country, ADMIN1), `time_id` is the temporal unit (i.e., `event_date` normally), and `time_target` is the temporal unit of aggregations (e.g., week, month, year). If `time_target = week`, it automatically uses the ACLED week (starting on Saturday).

As an example, we can take the data for South America.

```{r, echo = F}
library(here)
library(secret)
vault <- file.path(here::here(".vault"))
EMAIL_ADDRESS <- secret::get_secret("email_address", key = secret::local_key(), vault = vault)[[1]]
ACLED_KEY <- secret::get_secret("acled_key", key = secret::local_key(), vault = vault)[[1]]
```

```{r}
library(acledR)
df_sa <- acled_api(email = EMAIL_ADDRESS,
                key = ACLED_KEY,
                regions = c("South America"),
                start_date = "2022-01-01",
                end_date = "2022-04-30",
                monadic = F)
```

We can then generate event counts at the country-week level:
```{r}
df_sa_agg_weekly <-
  df_sa %>% 
  generate_counts(., 
                  unit_id = "country", 
                  time_id = "event_date",
                  time_target = "week")
```

This returns a tibble with columns for each event type in the data, as well as a column for the total events:
```{r}
df_sa_agg_weekly %>% 
  head() %>% 
  kableExtra::kable()
```


We can also request just certain event types. For example, we might only want political violence:
```{r}
df_sa_agg_weekly_pv <-
  df_sa %>% 
  generate_counts(., unit_id = "country", 
                  time_id = "event_date",
                  time_target = "week",
                  event_type = c("Battles", 
                                 "Violence against civilians", 
                                 "Explosions/Remote violence", 
                                 "Riots"))
```

And now we only retain the requested event types and the total corresponds to these types only:
```{r}
df_sa_agg_weekly %>% 
  head() %>% 
  kableExtra::kable()
```


If instead we wanted violent event counts by month rather than week, we would simply swap `time_target = week` to `time_target = month`:
```{r}
df_sa_agg_monthly_pv <-
  df_sa %>% 
  generate_counts(., unit_id = "country", 
                  time_id = "event_date",
                  time_target = "month",
                  event_type = c("Battles", 
                                 "Violence against civilians", 
                                 "Explosions/Remote violence", 
                                 "Riots"))
```


# Examples

## How have event types in Africa changed over time?

An analyst might be interested in how conflict event types have changed over time within a continent. In this example, let's consider Africa since 2018. Since ACLED codes multiple regions within each continent, we need to identify all regions that fall within Africa. We can see all ACLED regions by calling the `acledR::acled_regions` data:


Here, we see 5 regions in Africa, as well as the first date for which events were coded in each region. 

```{r}
acledR::acled_regions
```

We can store these region names in a vector called `africa_regions` and request data for each country within these regions since 2018.
```{r}
africa_regions <- c("Western Africa", 
                    "Middle Africa", 
                    "Eastern Africa", 
                    "Southern Africa",
                    "Northern Africa")

df_africa <- acled_api(email = EMAIL_ADDRESS,
                key = ACLED_KEY,
                regions = africa_regions,
                start_date = "2018-01-01",
                end_date = "2022-04-30",
                monadic = F)
```

We can then generate event counts for each month by each region in Africa:
```{r}
df_africa_monthly <-
  df_africa %>% 
  generate_counts(., unit_id = "region", 
                  time_id = "event_date",
                  time_target = "month",
                  event_type = c("Battles", 
                                 "Violence against civilians", 
                                 "Explosions/Remote violence", 
                                 "Riots"))
```


With some quick data wrangling to pivot the data such that each region-event type combination is one row and filtering out the `total_events` event type, we can create a stacked bar plot of event types over time by country with `ggplot2`:

```{r, fig.width=6, fig.height=8}
library(ggplot2)

df_africa_monthly %>% 
  tidyr::pivot_longer(cols = -c(region, event_month)) %>% 
  dplyr::filter(name != "total_events") %>% 
  
ggplot() +
  geom_bar(aes(x = event_month, 
               fill = name,
               y = value,
               group = region),
           position = "stack", stat = "identity") +
  facet_wrap(~region, nrow = 3) +
  scale_fill_viridis_d(option = "inferno", 
                       begin = 0.1,
                       end = 0.9,
                       guide = guide_legend(title = "Event Type",
                                            reverse = T)) +
  theme_light() +
  theme(legend.position = c(0.75, 0.15),
        legend.background = element_rect(color = "gray90"))



```




